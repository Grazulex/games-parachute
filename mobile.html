<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Parachute Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: #2a2a1a;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', monospace;
            touch-action: none;
        }

        #gameCanvas {
            display: block;
            background: #c8c3a0;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            max-width: 100vw;
            max-height: calc(100vh - 80px);
            width: 100%;
            height: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .hud {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 10;
        }

        .hud-item {
            background: rgba(0,0,0,0.5);
            padding: 8px 12px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .touch-zones {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            pointer-events: none;
            z-index: 5;
        }

        .touch-zone {
            flex: 1;
            pointer-events: all;
            touch-action: none;
        }

        .touch-zone.active {
            background: rgba(255,255,255,0.1);
        }

        .start-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .start-overlay.hidden {
            display: none;
        }

        .start-title {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
        }

        .start-subtitle {
            font-size: 20px;
            margin-bottom: 40px;
            opacity: 0.8;
        }

        .start-instructions {
            font-size: 16px;
            text-align: center;
            line-height: 1.8;
            max-width: 80%;
        }

        .tap-prompt {
            margin-top: 30px;
            font-size: 18px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }

        .game-over-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            backdrop-filter: blur(5px);
        }

        .game-over-overlay.visible {
            display: flex;
        }

        .game-over-title {
            font-size: 42px;
            margin-bottom: 30px;
            color: #ff4444;
        }

        .game-over-score {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .game-over-highscore {
            font-size: 18px;
            margin-bottom: 40px;
            color: #ffd700;
        }

        /* Indicateurs de direction */
        .direction-hint {
            position: absolute;
            bottom: 20px;
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            pointer-events: none;
        }

        .direction-hint.left {
            left: 20px;
        }

        .direction-hint.right {
            right: 20px;
        }
    </style>
</head>
<body>
    <!-- HUD -->
    <div class="hud">
        <div class="hud-item">
            <span id="score">000</span>
        </div>
        <div class="hud-item">
            ‚ù§Ô∏è <span id="lives">3</span>
        </div>
        <div class="hud-item">
            LV <span id="level">1</span>
        </div>
    </div>

    <!-- Canvas -->
    <canvas id="gameCanvas" width="450" height="233"></canvas>

    <!-- Zones tactiles -->
    <div class="touch-zones">
        <div class="touch-zone" id="leftZone"></div>
        <div class="touch-zone" id="rightZone"></div>
    </div>

    <!-- Indicateurs de direction -->
    <div class="direction-hint left">‚Üê GAUCHE</div>
    <div class="direction-hint right">DROITE ‚Üí</div>

    <!-- Overlay de d√©marrage -->
    <div class="start-overlay" id="startOverlay">
        <div class="start-title">PARACHUTE</div>
        <div class="start-subtitle">Nintendo Game & Watch (1981)</div>
        <div class="start-instructions">
            üì± Tapez √† GAUCHE ou DROITE pour d√©placer le bateau<br>
            üéØ Attrapez les parachutistes !<br>
            üíÄ 3 erreurs = Game Over
        </div>
        <div class="tap-prompt">üëÜ Tapez pour commencer</div>
    </div>

    <!-- Overlay Game Over -->
    <div class="game-over-overlay" id="gameOverOverlay">
        <div class="game-over-title">GAME OVER</div>
        <div class="game-over-score">Score: <span id="finalScore">0</span></div>
        <div class="game-over-highscore">Record: <span id="finalHighScore">0</span></div>
        <div class="tap-prompt">üëÜ Tapez pour rejouer</div>
    </div>

    <script src="sprites/parachute-sprites.js"></script>
    <script src="sounds.js"></script>
    <script>
        // ============================================
        // JEU PARACHUTE MOBILE
        // ============================================

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Couleurs LCD
        const LCD_DARK = '#1a1a0f';
        const LCD_BG = '#c8c3a0';

        // Charger le background
        const backgroundImage = new Image();
        backgroundImage.src = 'sprites/perfect-bg.png';
        let backgroundLoaded = false;

        backgroundImage.onload = () => {
            backgroundLoaded = true;
            drawStartScreen();
        };

        // Syst√®me de sons
        const sounds = new GameSounds();

        // Configuration
        const CONFIG = {
            FPS: 10,
            SPAWN_INTERVAL: 2500,
            FALL_SPEED: 900,
            SHARK_DURATION: 1500
        };

        // Positions
        const COLUMNS = {
            LEFT: { x: 100, frames: 7, sprites: 'parachutists_left' },
            MIDDLE: { x: 225, frames: 6, sprites: 'parachutists_middle' },
            RIGHT: { x: 350, frames: 5, sprites: 'parachutists_right' }
        };

        const BOAT_POSITIONS = {
            LEFT: { x: 80, y: 195, sprite: 'lboat' },
            MIDDLE: { x: 205, y: 195, sprite: 'mboat' },
            RIGHT: { x: 330, y: 195, sprite: 'rboat' }
        };

        // √âtat du jeu
        let gameState = {
            running: false,
            score: 0,
            misses: 0,
            lives: 3,
            highScore: 0,
            level: 1,
            boatPosition: 'MIDDLE',
            parachutists: [],
            sharks: [],
            sharkFins: [],
            lastSpawnTime: 0,
            lastFinSpawn: Date.now(),
            gameOver: false,
            lastMoveTime: 0
        };

        // Charger high score
        function loadHighScore() {
            const saved = localStorage.getItem('parachute_mobile_highscore');
            if (saved) {
                gameState.highScore = parseInt(saved);
            }
        }

        function saveHighScore() {
            localStorage.setItem('parachute_mobile_highscore', gameState.highScore);
        }

        // Classe Parachutiste
        class Parachutist {
            constructor(column) {
                this.column = column;
                this.columnData = COLUMNS[column];
                this.frame = 1;
                this.maxFrames = this.columnData.frames;
                this.x = this.columnData.x;
                this.lastFrameTime = Date.now();
                this.caught = false;
                this.missed = false;
            }

            update() {
                const fallSpeed = Math.max(400, CONFIG.FALL_SPEED - (gameState.level - 1) * 50);
                const now = Date.now();

                if (now - this.lastFrameTime > fallSpeed) {
                    this.frame++;
                    this.lastFrameTime = now;

                    if (this.frame > this.maxFrames) {
                        this.checkCatch();
                        return true;
                    }
                }
                return false;
            }

            checkCatch() {
                const boatPos = gameState.boatPosition;

                if (
                    (this.column === 'LEFT' && boatPos === 'LEFT') ||
                    (this.column === 'MIDDLE' && boatPos === 'MIDDLE') ||
                    (this.column === 'RIGHT' && boatPos === 'RIGHT')
                ) {
                    this.caught = true;
                    gameState.score++;
                    sounds.catch();
                    checkLevelUp();
                    updateHUD();
                } else {
                    this.missed = true;
                    gameState.misses++;
                    gameState.lives = 3 - gameState.misses;
                    sounds.miss();
                    addShark(this.column);
                    updateHUD();

                    if (gameState.misses >= 3) {
                        endGame();
                    }
                }
            }

            draw() {
                if (this.frame <= this.maxFrames) {
                    const prefix = this.column === 'LEFT' ? 'l' : this.column === 'MIDDLE' ? 'm' : 'r';
                    const spriteName = `${this.columnData.sprites}.${prefix}par${this.frame}`;
                    const yPos = 25 + (this.frame - 1) * 25;
                    ParachuteSprites.draw(ctx, spriteName, this.x - 10, yPos, 2, LCD_DARK);
                }
            }
        }

        // Classe Requin
        class Shark {
            constructor(column) {
                this.column = column;
                this.x = COLUMNS[column].x;
                this.y = 184;
                this.createdAt = Date.now();
                this.frame = 1;
            }

            shouldRemove() {
                return Date.now() - this.createdAt > CONFIG.SHARK_DURATION;
            }

            draw() {
                const elapsed = Date.now() - this.createdAt;
                this.frame = Math.min(6, Math.floor(elapsed / 100) + 1);
                ParachuteSprites.draw(ctx, `sharks.shark${this.frame}`, this.x - 15, this.y, 2, LCD_DARK);
            }
        }

        // Classe Nageoire
        class SharkFin {
            constructor() {
                this.x = Math.random() * (canvas.width - 50) + 25;
                this.y = 195 + Math.random() * 20;
                this.type = Math.random() < 0.85 ? Math.floor(Math.random() * 4) + 1 : 5;
                this.createdAt = Date.now();
                this.duration = 2000 + Math.random() * 2000;
                this.alpha = 0;
                this.fadeInDuration = 500;
                this.fadeOutStart = this.duration - 500;
            }

            shouldRemove() {
                return Date.now() - this.createdAt > this.duration;
            }

            draw() {
                const elapsed = Date.now() - this.createdAt;

                if (elapsed < this.fadeInDuration) {
                    this.alpha = elapsed / this.fadeInDuration;
                } else if (elapsed > this.fadeOutStart) {
                    this.alpha = 1 - ((elapsed - this.fadeOutStart) / 500);
                } else {
                    this.alpha = 1;
                }

                if (this.alpha > 0) {
                    ctx.globalAlpha = this.alpha;
                    ParachuteSprites.draw(ctx, `shark_fins.lshark${this.type}`, this.x, this.y, 2, LCD_DARK);
                    ctx.globalAlpha = 1;
                }
            }
        }

        function addShark(column) {
            gameState.sharks.push(new Shark(column));
        }

        function spawnParachutist() {
            const columns = Object.keys(COLUMNS);
            const randomColumn = columns[Math.floor(Math.random() * columns.length)];
            gameState.parachutists.push(new Parachutist(randomColumn));
        }

        function spawnSharkFin() {
            if (gameState.sharkFins.length < 3) {
                gameState.sharkFins.push(new SharkFin());
            }
        }

        function moveBoat(direction) {
            if (!gameState.running || gameState.gameOver) return;

            const now = Date.now();
            if (now - gameState.lastMoveTime < 100) return;
            gameState.lastMoveTime = now;

            const positions = ['LEFT', 'MIDDLE', 'RIGHT'];
            const currentIndex = positions.indexOf(gameState.boatPosition);

            if (direction === 'left' && currentIndex > 0) {
                gameState.boatPosition = positions[currentIndex - 1];
                sounds.move();
            } else if (direction === 'right' && currentIndex < 2) {
                gameState.boatPosition = positions[currentIndex + 1];
                sounds.move();
            }
        }

        function checkLevelUp() {
            const newLevel = Math.floor(gameState.score / 10) + 1;
            if (newLevel > gameState.level) {
                gameState.level = newLevel;
                sounds.levelUp();
            }
        }

        function updateHUD() {
            document.getElementById('score').textContent = gameState.score.toString().padStart(3, '0');
            document.getElementById('lives').textContent = gameState.lives;
            document.getElementById('level').textContent = gameState.level;
        }

        function drawBackground() {
            if (backgroundLoaded) {
                const drawWidth = canvas.width * 1.1;
                const bgRatio = backgroundImage.width / backgroundImage.height;
                const drawHeight = drawWidth / bgRatio;
                const offsetX = -(drawWidth - canvas.width) / 2;
                const offsetY = (canvas.height - drawHeight) / 2;

                ctx.fillStyle = LCD_BG;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(backgroundImage, offsetX, offsetY, drawWidth, drawHeight);
                ctx.fillStyle = 'rgba(200, 195, 160, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                ctx.fillStyle = LCD_BG;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        function drawHelicopter() {
            const time = Date.now() / 100;
            const heliX = 390;
            const heliY = 10;

            ctx.fillStyle = LCD_DARK;
            ctx.fillRect(heliX - 10, heliY, 20, 8);
            ctx.fillRect(heliX - 5, heliY - 3, 10, 3);

            const angle = time % (Math.PI * 2);
            ctx.save();
            ctx.translate(heliX, heliY - 3);
            ctx.rotate(angle);
            ctx.fillRect(-15, -1, 30, 2);
            ctx.restore();
        }

        function gameLoop() {
            if (!gameState.running) return;

            drawBackground();

            const now = Date.now();
            const spawnInterval = Math.max(1000, CONFIG.SPAWN_INTERVAL - (gameState.level - 1) * 100);
            if (now - gameState.lastSpawnTime > spawnInterval) {
                spawnParachutist();
                gameState.lastSpawnTime = now;
            }

            drawHelicopter();

            gameState.parachutists = gameState.parachutists.filter(p => {
                const shouldRemove = p.update();
                if (!shouldRemove) p.draw();
                return !shouldRemove;
            });

            const finSpawnInterval = 4000 + Math.random() * 4000;
            if (now - gameState.lastFinSpawn > finSpawnInterval) {
                spawnSharkFin();
                gameState.lastFinSpawn = now;
            }

            gameState.sharkFins = gameState.sharkFins.filter(fin => {
                if (!fin.shouldRemove()) {
                    fin.draw();
                    return true;
                }
                return false;
            });

            gameState.sharks = gameState.sharks.filter(s => {
                if (!s.shouldRemove()) {
                    s.draw();
                    return true;
                }
                return false;
            });

            const boatPos = BOAT_POSITIONS[gameState.boatPosition];
            ParachuteSprites.draw(ctx, `boats.${boatPos.sprite}`, boatPos.x, boatPos.y, 2, LCD_DARK);

            setTimeout(gameLoop, 1000 / CONFIG.FPS);
        }

        function startGame() {
            gameState = {
                running: true,
                score: 0,
                misses: 0,
                lives: 3,
                highScore: gameState.highScore,
                level: 1,
                boatPosition: 'MIDDLE',
                parachutists: [],
                sharks: [],
                sharkFins: [],
                lastSpawnTime: Date.now(),
                lastFinSpawn: Date.now(),
                gameOver: false,
                lastMoveTime: 0
            };

            document.getElementById('startOverlay').classList.add('hidden');
            document.getElementById('gameOverOverlay').classList.remove('visible');

            sounds.gameStart();
            updateHUD();
            gameLoop();
        }

        function endGame() {
            gameState.gameOver = true;
            gameState.running = false;

            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                saveHighScore();
                sounds.highScore();
            } else {
                sounds.gameOver();
            }

            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalHighScore').textContent = gameState.highScore;

            setTimeout(() => {
                document.getElementById('gameOverOverlay').classList.add('visible');
            }, 500);
        }

        function drawStartScreen() {
            drawBackground();

            ctx.fillStyle = LCD_DARK;
            ctx.font = 'bold 36px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('PARACHUTE', canvas.width / 2, 60);

            ctx.font = '16px monospace';
            ctx.fillText('Nintendo Game & Watch', canvas.width / 2, 85);
            ctx.fillText('(1981)', canvas.width / 2, 105);

            ParachuteSprites.draw(ctx, 'parachutists_middle.mpar4', 205, 120, 2.5, LCD_DARK);

            ctx.font = '16px monospace';
            ctx.fillText('Mobile Edition', canvas.width / 2, 190);
        }

        // ============================================
        // CONTR√îLES TACTILES
        // ============================================

        const leftZone = document.getElementById('leftZone');
        const rightZone = document.getElementById('rightZone');
        const startOverlay = document.getElementById('startOverlay');
        const gameOverOverlay = document.getElementById('gameOverOverlay');

        // D√©marrer le jeu au premier tap
        startOverlay.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startGame();
        }, { passive: false });

        gameOverOverlay.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startGame();
        }, { passive: false });

        // Contr√¥les gauche/droite
        leftZone.addEventListener('touchstart', (e) => {
            e.preventDefault();
            leftZone.classList.add('active');
            moveBoat('left');
        }, { passive: false });

        leftZone.addEventListener('touchend', (e) => {
            e.preventDefault();
            leftZone.classList.remove('active');
        }, { passive: false });

        rightZone.addEventListener('touchstart', (e) => {
            e.preventDefault();
            rightZone.classList.add('active');
            moveBoat('right');
        }, { passive: false });

        rightZone.addEventListener('touchend', (e) => {
            e.preventDefault();
            rightZone.classList.remove('active');
        }, { passive: false });

        // Support clavier (pour tester sur desktop)
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') moveBoat('left');
            else if (e.key === 'ArrowRight') moveBoat('right');
            else if (e.key === ' ' || e.key === 'Enter') {
                if (!gameState.running) startGame();
            }
        });

        // Emp√™cher le zoom sur double-tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Initialiser
        loadHighScore();
        updateHUD();

        // Afficher √©cran de chargement
        ctx.fillStyle = LCD_BG;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = LCD_DARK;
        ctx.font = '18px monospace';
        ctx.textAlign = 'center';
        ctx.fillText('Chargement...', canvas.width / 2, canvas.height / 2);

        setTimeout(() => {
            drawStartScreen();
        }, 100);

        console.log('üéÆ Parachute Mobile charg√© !');
    </script>
</body>
</html>
